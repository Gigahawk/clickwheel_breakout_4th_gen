name: "Generate PCB production outputs"

on: push

jobs:
  fab-files:
    env:
      KIBOT_QR_CONFIG: kibot_qr.yaml
    name: PCB fabrication files
    runs-on: ubuntu-latest
    container: setsoft/kicad_auto:ki6.0.7_Debian
    steps:
      - uses: actions/checkout@v2

      - name: Cache date
        run: echo "DATE=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV

      - name: Generate QR code text
        run: python3 ./scripts/gen_qr_kibot_config.py

      - name: Generate QR code footprint/symbol
        run: kibot -c "$KIBOT_QR_CONFIG"

      - name: Generate manufacturing outputs
        run: kibot -c kibot_export.yaml

      - name: Upload 3D models
        if: ${{ !env.ACT }}
        uses: actions/upload-artifact@v3
        with:
          name: 3D
          path: 3D

      - name: Upload gerbers
        if: ${{ !env.ACT }}
        uses: actions/upload-artifact@v3
        with:
          name: gerbers
          path: Manufacturers

      - name: Upload schematics
        if: ${{ !env.ACT }}
        uses: actions/upload-artifact@v3
        with:
          name: schematics
          path: Schematic
